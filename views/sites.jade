extends layout

block body

  div#sitesmap(data-role="page")
    div(data-role="header", data-theme="b")
      h1 Towers

    div#map-canvas(data-role="content")


    div.ui-bar(data-role="footer", data-position="fixed")
      div.ui-navbar.ui-mini(data-role="navbar", role="navigation")
        ul.ui-grid-d
          li
            a(href="/main", data-icon="home", data-corners="false", data-shadow="false", data-iconshadow="true", data-wrapperels="span", data-iconpos="top", data-theme="a", data-inline="true", class="ui-btn ui-btn-inline ui-btn-icon-top ui-btn-up-a")
              span.ui-btn-inner 
                span.ui-btn-text Home
              span.ui-icon.ui-icon-grid.ui-icon-shadow &nbsp;
          li
            a(href="/markets/1", data-icon="star", data-corners="false", data-shadow="false", data-iconshadow="true", data-wrapperels="span", data-iconpos="top", data-theme="a", data-inline="true", class="ui-btn ui-btn-inline ui-btn-icon-top ui-btn-up-a")
              span.ui-btn-inner 
                span.ui-btn-text Markets
              span.ui-icon.ui-icon-grid.ui-icon-shadow &nbsp;
          li
            a(href="/logout", data-icon="delete", data-corners="false", data-shadow="false", data-iconshadow="true", data-wrapperels="span", data-iconpos="top", data-theme="a", data-inline="true", class="ui-btn ui-btn-inline ui-btn-icon-top ui-btn-up-a")
              span.ui-btn-inner 
                span.ui-btn-text Logout
              span.ui-icon.ui-icon-grid.ui-icon-shadow &nbsp;



  script.

    //- $(document).delegate('#sitesmap', 'pageinit', function () {
    //-     initialize();
    //- });           

    //- $( '#sitesmap' ).on( 'pageinit',function(event){
    //-   alert( 'This page was just enhanced by jQuery Mobile!' );
    //-   initialize();
    //- });    


    function resizeMap() {
      $('[data-role=content]')
            .height(
              $(window).height() - 
              (5 + $('[data-role=header]').last().height() 
              + $('[data-role=footer]').last().height())
            );    
    }

    //- $(document).ready(function() {
    function initialize() {
    //- $(document).on("pageinit", "#sitesmap", function() {
    //- $( '#sitesmap' ).on( 'pageinit',function(event){

      var map = new google.maps.Map(document.getElementById("map-canvas"));

      navigator.geolocation.getCurrentPosition(success);
      function success(position) {
        var pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            
        map.setOptions({
          zoom: 10,
          center: pos,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        });

      }      

      resizeMap();
      google.maps.event.trigger(map, 'resize');    
      
    //- };    

    function addMarker (lat, long, title, description) {
        var myLatlng = new google.maps.LatLng(lat,long);
        var marker = new google.maps.Marker({ position: myLatlng, map: map });

        var contentString = '<div id="content">'+
            '<div id="siteNotice">'+
            '</div>'+
            '<h1 id="firstHeading" class="firstHeading">' + title + '</h1>'+
            '<div id="bodyContent">'+ description + 
            '</div>'+
            '</div>';

        var infowindow = new google.maps.InfoWindow({
            content: contentString
        });

        google.maps.event.addListener(map, 'click', function() {
          infowindow.close();
        });

        google.maps.event.addListener(marker, 'click', function() {
          infowindow.open(map,marker);        
        });   

        google.maps.event.addDomListener(window, 'resize', function() {
          resizeMap();
          google.maps.event.trigger(map, 'resize');  
        });      

      }


      $.ajax({
        url: "/getSites/#{market}",
        cache: false,
        type: "GET",
        success: function(data) { 
          var jdata = JSON.parse(data);
          $.each(jdata.items, function(index, element) {
            addMarker(element.Latitude, element.Longitude, element.SiteName, 'GC: ' + element.GeneralContractorPOC + ' (' + element.GeneralContractorName + ')<br>Status: ' + element.SiteStatus)
          });
          var pos = new google.maps.LatLng(jdata.items[0].Latitude, jdata.items[0].Longitude);
          map.setCenter(pos)

        }  
      });

    };    


    //- $(document).on("pageshow", "#sitesmap", function() { 
    //-   //- alert( 'This page was just enhanced by jQuery Mobile!' );
    //-   initialize();
    //- });


